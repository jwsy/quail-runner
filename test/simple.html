<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quail Runner - Simple</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <script src="https://unpkg.com/kaplay@3001.0.0/dist/kaplay.js"></script>
    <script>
        // Initialize kaplay
        kaplay({
            width: 932,
            height: 430,
            background: [30, 30, 50],
        });

        // Constants
        const GROUND_HEIGHT = 80;
        const GROUND_Y = height() - GROUND_HEIGHT;
        
        let gameSpeed = 300;
        let score = 0;
        let gameRunning = false;
        let canDoubleJump = false;
        let chargeTime = 0;
        let charging = false;
        let jumpedEnemies = 0;

        // Ground
        const ground = add([
            rect(width(), GROUND_HEIGHT),
            pos(0, GROUND_Y),
            color(60, 120, 60),
            area(),
            body({ isStatic: true }),
            "ground"
        ]);

        // Player (Quail)
        const player = add([
            rect(40, 30),
            pos(120, GROUND_Y - 30),
            color(139, 69, 19), // Brown
            area(),
            body(),
            "player"
        ]);

        // Player eye
        add([
            circle(4),
            pos(130, GROUND_Y - 22),
            color(255, 215, 0), // Gold
            "eye"
        ]);

        // UI
        const scoreLabel = add([
            text("Score: 0", { size: 24 }),
            pos(20, 20),
            color(255, 255, 255),
        ]);

        const chargeBar = add([
            rect(0, 6),
            pos(120, GROUND_Y - 50),
            color(255, 255, 0),
            opacity(0),
        ]);

        // Trail system
        let trailPoints = [];

        function addTrailPoint() {
            if (player.isGrounded() && gameRunning) {
                trailPoints.push({
                    pos: vec2(player.pos.x - 20, player.pos.y + 10),
                    life: 1.0
                });
            }
        }

        function updateTrail() {
            for (let i = trailPoints.length - 1; i >= 0; i--) {
                const point = trailPoints[i];
                point.life -= dt() * 3;
                
                if (point.life <= 0) {
                    trailPoints.splice(i, 1);
                } else {
                    const size = point.life * 8;
                    const alpha = point.life * 0.8;
                    drawRect({
                        pos: point.pos,
                        width: size,
                        height: size,
                        color: rgb(160, 32, 240), // Neon purple
                        opacity: alpha
                    });
                }
            }
        }

        // Enemy spawning
        function spawnEnemy() {
            if (!gameRunning) return;
            
            const enemy = add([
                rect(30, 20),
                pos(width() + 50, GROUND_Y - 20),
                color(220, 20, 60), // Red
                area(),
                move(LEFT, gameSpeed),
                "enemy",
                { scored: false }
            ]);

            // Cassette tape details
            add([
                circle(4),
                pos(8, 8),
                color(139, 0, 0),
                parent(enemy),
            ]);

            add([
                circle(4),
                pos(22, 8),
                color(139, 0, 0),
                parent(enemy),
            ]);

            add([
                rect(20, 2),
                pos(5, 16),
                color(139, 0, 0),
                parent(enemy),
            ]);
        }

        // Confetti system
        function createConfetti(x, y) {
            for (let i = 0; i < 6; i++) {
                add([
                    text("ðŸ‡ºðŸ‡¸", { size: 14 }),
                    pos(x + rand(-15, 15), y + rand(-15, 15)),
                    lifespan(1.5, { fade: 0.5 }),
                    {
                        velocity: vec2(rand(-100, 100), rand(-150, -50)),
                        angularVel: rand(-360, 360)
                    }
                ]);
            }
        }

        // Toasty effect
        function showToasty() {
            const toastyBox = add([
                rect(100, 60),
                pos(width() - 110, 20),
                color(255, 100, 100),
                lifespan(2),
                scale(0),
            ]);

            const toastyText = add([
                text("TOASTY!", { size: 18 }),
                pos(width() - 105, 40),
                color(255, 255, 0),
                lifespan(2),
                scale(0),
            ]);

            // Animate in
            tween(0, 1, 0.3, (val) => {
                toastyBox.scale = val;
                toastyText.scale = val;
            });
        }

        // Jump mechanics
        function jump(force = 500) {
            if (player.isGrounded()) {
                player.jump(force);
                canDoubleJump = true;
            } else if (canDoubleJump) {
                player.jump(force * 0.7);
                canDoubleJump = false;
            }
        }

        // Input handling
        onKeyPress("space", () => {
            if (!gameRunning) {
                startGame();
                return;
            }
            jump();
        });

        onKeyDown("space", () => {
            if (gameRunning && player.isGrounded() && !charging) {
                charging = true;
                chargeTime = 0;
            }
        });

        onKeyRelease("space", () => {
            if (charging) {
                charging = false;
                const force = 500 + Math.min(chargeTime * 300, 400);
                player.jump(force);
                canDoubleJump = true;
                chargeTime = 0;
            }
        });

        // Touch controls
        onClick(() => {
            if (!gameRunning) {
                startGame();
                return;
            }
            jump();
        });

        // Game loop
        onUpdate(() => {
            if (!gameRunning) return;

            // Update trail
            addTrailPoint();
            updateTrail();

            // Update charging
            if (charging) {
                chargeTime += dt();
                const chargePercent = Math.min(chargeTime / 1.5, 1);
                chargeBar.width = chargePercent * 80;
                chargeBar.opacity = 0.8;
            } else {
                chargeBar.opacity = 0;
            }

            // Update score display
            scoreLabel.text = "Score: " + score;

            // Increase game speed
            gameSpeed += dt() * 20;

            // Update enemy movement speed
            every("enemy", (enemy) => {
                enemy.move = vec2(-gameSpeed, 0);
                
                // Check if player passed enemy
                if (!enemy.scored && enemy.pos.x < player.pos.x - 20) {
                    enemy.scored = true;
                    score += 10;
                    jumpedEnemies++;
                    createConfetti(enemy.pos.x, enemy.pos.y);
                    
                    if (jumpedEnemies % 3 === 0) {
                        showToasty();
                    }
                }

                // Remove off-screen enemies
                if (enemy.pos.x < -50) {
                    destroy(enemy);
                }
            });
        });

        // Collision detection
        player.onCollide("enemy", () => {
            gameOver();
        });

        // Start game
        function startGame() {
            gameRunning = true;
            
            // Remove start text
            destroyAll("startText");
            
            // Start enemy spawning
            const spawnLoop = loop(rand(1, 2.5), () => {
                if (gameRunning) {
                    spawnEnemy();
                }
            });
        }

        // Game over
        function gameOver() {
            gameRunning = false;
            
            add([
                text(`GAME OVER\n\nScore: ${score}\nEnemies Jumped: ${jumpedEnemies}\n\nPress SPACE to restart`, {
                    size: 24,
                    align: "center"
                }),
                pos(center()),
                color(255, 100, 100),
                anchor("center"),
            ]);

            onKeyPress("space", () => {
                go("game");
            });

            onClick(() => {
                go("game");
            });
        }

        // Start screen
        add([
            text("QUAIL RUNNER\n\nAvoid the Red Tape!\n\nPress SPACE or TAP to start\n\nControls:\nâ€¢ Space/Tap: Jump\nâ€¢ Hold Space: Charge mega jump\nâ€¢ Double tap: Double jump", {
                size: 18,
                align: "center"
            }),
            pos(center()),
            color(255, 255, 0),
            anchor("center"),
            "startText"
        ]);

        // Scene management
        scene("game", () => {
            // Restart the game by reloading
            go();
        });
    </script>
</body>
</html>