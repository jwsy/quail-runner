<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quail Runner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #333;
            max-width: 100vw;
            max-height: 100vh;
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas"></canvas>
    
    <script src="https://unpkg.com/kaplay@3001.0.0/dist/kaplay.js"></script>
    <script>
        // Initialize kaplay
        kaplay({
            canvas: document.getElementById("gameCanvas"),
            width: 932,
            height: 430,
            background: [20, 20, 40],
        });

        // Game constants
        const GROUND_Y = height() - 80;
        const QUAIL_START_X = 100;
        
        // Game state
        let gameSpeed = 200;
        let score = 0;
        let canDoubleJump = false;
        let megaJumpCharging = false;
        let megaJumpCharge = 0;
        let enemiesJumped = 0;
        let gameStarted = false;

        // Create ground
        add([
            rect(width(), 80),
            pos(0, GROUND_Y),
            color(50, 100, 50),
            area(),
            body({ isStatic: true }),
            "ground"
        ]);

        // Create quail player
        const quail = add([
            rect(40, 30),
            pos(QUAIL_START_X, GROUND_Y - 30),
            color(139, 69, 19),
            area(),
            body(),
            "quail"
        ]);

        // Add eyes to quail
        add([
            rect(8, 8),
            pos(QUAIL_START_X + 5, GROUND_Y - 25),
            color(255, 215, 0),
            parent(quail),
        ]);

        // Score display
        const scoreText = add([
            text("Score: 0", { size: 24 }),
            pos(20, 20),
            color(255, 255, 255),
        ]);

        // Charge bar for mega jump
        const chargeBar = add([
            rect(0, 8),
            pos(QUAIL_START_X, GROUND_Y - 50),
            color(255, 255, 0),
            opacity(0),
        ]);

        // Trail particles array
        let trailParticles = [];

        // Create purple trail
        function createTrail() {
            if (quail.isGrounded()) {
                trailParticles.push({
                    x: quail.pos.x - 20,
                    y: quail.pos.y + 15,
                    life: 0.5,
                    maxLife: 0.5
                });
            }
        }

        // Update trail particles
        function updateTrail() {
            for (let i = trailParticles.length - 1; i >= 0; i--) {
                let particle = trailParticles[i];
                particle.life -= dt();
                
                if (particle.life <= 0) {
                    trailParticles.splice(i, 1);
                } else {
                    const alpha = particle.life / particle.maxLife;
                    const size = alpha * 6;
                    
                    drawRect({
                        pos: vec2(particle.x, particle.y),
                        width: size,
                        height: size,
                        color: rgb(160, 32, 240),
                        opacity: alpha * 0.8
                    });
                }
            }
        }

        // Create cassette enemy
        function spawnCassette() {
            const cassette = add([
                rect(30, 20),
                pos(width() + 50, GROUND_Y - 20),
                color(220, 20, 60),
                area(),
                move(LEFT, gameSpeed),
                "cassette",
                { passed: false }
            ]);

            // Add cassette details
            add([
                rect(8, 8),
                pos(5, 5),
                color(139, 0, 0),
                parent(cassette),
            ]);

            add([
                rect(8, 8),
                pos(17, 5),
                color(139, 0, 0),
                parent(cassette),
            ]);

            return cassette;
        }

        // Create confetti
        function createConfetti(x, y) {
            for (let i = 0; i < 8; i++) {
                add([
                    text("ðŸ‡ºðŸ‡¸", { size: 16 }),
                    pos(x + rand(-20, 20), y + rand(-20, 20)),
                    lifespan(2),
                    {
                        vel: vec2(rand(-50, 50), rand(-100, -50)),
                        angVel: rand(-360, 360)
                    }
                ]);
            }
        }

        // Show toasty
        function showToasty() {
            add([
                rect(80, 80),
                pos(width() - 90, 10),
                color(255, 100, 100),
                lifespan(2),
            ]);
            
            add([
                text("TOASTY!", { size: 20 }),
                pos(width() - 150, 100),
                color(255, 255, 0),
                lifespan(2),
            ]);
        }

        // Handle jump
        function handleJump(force = 400) {
            if (quail.isGrounded()) {
                quail.jump(force);
                canDoubleJump = true;
            } else if (canDoubleJump) {
                quail.jump(force * 0.8);
                canDoubleJump = false;
            }
        }

        // Main game loop
        onUpdate(() => {
            if (!gameStarted) return;

            // Create trail
            createTrail();
            updateTrail();

            // Update score
            scoreText.text = "Score: " + score;

            // Update charge bar
            if (megaJumpCharging) {
                megaJumpCharge = Math.min(megaJumpCharge + dt() * 2, 1);
                chargeBar.width = megaJumpCharge * 100;
                chargeBar.opacity = 0.8;
            } else {
                chargeBar.opacity = 0;
            }

            // Increase game speed
            gameSpeed += dt() * 10;

            // Check cassette collisions and scoring
            every("cassette", (cassette) => {
                if (!cassette.passed && cassette.pos.x < quail.pos.x) {
                    cassette.passed = true;
                    score += 10;
                    enemiesJumped++;
                    createConfetti(cassette.pos.x, cassette.pos.y);
                    
                    if (enemiesJumped % 3 === 0) {
                        showToasty();
                    }
                }

                if (cassette.pos.x < -50) {
                    destroy(cassette);
                }
            });
        });

        // Input handling
        onKeyPress("space", () => {
            if (!gameStarted) {
                gameStarted = true;
                // Start spawning cassettes
                loop(2, () => {
                    if (gameStarted) {
                        spawnCassette();
                    }
                });
                return;
            }
            handleJump();
        });

        onKeyDown("space", () => {
            if (gameStarted && !megaJumpCharging && quail.isGrounded()) {
                megaJumpCharging = true;
                megaJumpCharge = 0;
            }
        });

        onKeyRelease("space", () => {
            if (megaJumpCharging) {
                megaJumpCharging = false;
                const jumpForce = 400 + (megaJumpCharge * 200);
                quail.jump(jumpForce);
                canDoubleJump = true;
                megaJumpCharge = 0;
            }
        });

        // Touch handling
        onClick(() => {
            if (!gameStarted) {
                gameStarted = true;
                loop(2, () => {
                    if (gameStarted) {
                        spawnCassette();
                    }
                });
                return;
            }
            handleJump();
        });

        // Collision detection
        quail.onCollide("cassette", () => {
            gameStarted = false;
            add([
                text("GAME OVER\nFinal Score: " + score + "\nPress SPACE to restart", { 
                    size: 24,
                    align: "center"
                }),
                pos(center()),
                color(255, 0, 0),
                anchor("center"),
            ]);

            onKeyPress("space", () => {
                go("restart");
            });
        });

        // Start screen
        add([
            text("QUAIL RUNNER\nTap or Press SPACE to start\n\nControls:\nSpace: Jump\nHold Space: Mega Jump\nDouble Tap: Double Jump", { 
                size: 20,
                align: "center"
            }),
            pos(center()),
            color(255, 255, 0),
            anchor("center"),
            "startText"
        ]);

        // Restart scene
        scene("restart", () => {
            go("main");
        });

        scene("main", () => {
            // This scene would recreate everything, but for now we'll just reload
            location.reload();
        });

        go("main");
    </script>
</body>
</html>