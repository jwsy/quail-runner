<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Quail Runner</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: 'Courier New', monospace;
            overflow: hidden;
        }
        canvas {
            border: 2px solid #333;
            max-width: 100vw;
            max-height: 100vh;
        }
        .game-container {
            position: relative;
        }
        .instructions {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 12px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="instructions">
            Tap/Space: Jump | Hold Space: Mega Jump | Double Tap: Double Jump
        </div>
        <canvas id="gameCanvas"></canvas>
    </div>
    
    <script src="https://unpkg.com/kaplay@3001.0.0/dist/kaplay.js"></script>
    <script>
        // Initialize kaplay with iPhone 15 landscape dimensions
        const k = kaplay({
            canvas: document.getElementById("gameCanvas"),
            width: 932,  // iPhone 15 landscape width
            height: 430, // iPhone 15 landscape height
            background: [20, 20, 40],
            crisp: true,
        });

        // Game constants
        const GROUND_Y = k.height() - 80;
        const QUAIL_START_X = 100;
        const GRAVITY = 1200;
        const JUMP_FORCE = -400;
        const MEGA_JUMP_FORCE = -600;
        const GAME_SPEED = 200;
        
        // Game state
        let gameSpeed = GAME_SPEED;
        let score = 0;
        let jumpCount = 0;
        let canDoubleJump = false;
        let megaJumpCharging = false;
        let megaJumpCharge = 0;
        let enemiesJumped = 0;
        let lastJumpTime = 0;
        let gameStarted = false;

        // Create ground
        function createGround() {
            return k.add([
                k.rect(k.width(), 80),
                k.pos(0, GROUND_Y),
                k.color(50, 100, 50),
                k.area(),
                k.body({ isStatic: true }),
                "ground"
            ]);
        }

        // Create quail player
        function createQuail() {
            const quail = k.add([
                k.rect(40, 30), // Simple rectangle for now
                k.pos(QUAIL_START_X, GROUND_Y - 30),
                k.color(139, 69, 19), // Brown color for quail
                k.area(),
                k.body(),
                "quail"
            ]);
            
            return quail;
        }

        // Create purple trail effect
        function createTrail(x, y) {
            const trail = add([
                rect(4, 4),
                pos(x, y),
                color(160, 32, 240),  // Neon purple
                opacity(0.8),
                lifespan(0.5),
                "trail"
            ]);
            
            // Fade out effect
            trail.onUpdate(() => {
                trail.opacity -= dt() * 2;
                trail.scale -= dt() * 2;
            });
        }

        // Create cassette tape enemy
        function createCassette() {
            const cassette = add([
                sprite("cassette"),
                pos(width() + 50, GROUND_Y - 20),
                area(),
                body({ isStatic: true }),
                scale(1.5),
                "cassette",
                { passed: false }
            ]);
            
            cassette.onUpdate(() => {
                cassette.move(-gameSpeed, 0);
                
                // Check if quail has passed this cassette
                if (!cassette.passed && cassette.pos.x < quail.pos.x) {
                    cassette.passed = true;
                    score += 10;
                    enemiesJumped++;
                    
                    // Create US flag confetti
                    createConfetti(cassette.pos.x, cassette.pos.y);
                    
                    // Check for toasty moment
                    if (enemiesJumped % 3 === 0) {
                        showToasty();
                    }
                }
                
                // Remove when off screen
                if (cassette.pos.x < -50) {
                    destroy(cassette);
                }
            });
            
            return cassette;
        }

        // Create US flag emoji confetti
        function createConfetti(x, y) {
            for (let i = 0; i < 8; i++) {
                const confetti = add([
                    text("ðŸ‡ºðŸ‡¸", { size: 16 }),
                    pos(x + rand(-20, 20), y + rand(-20, 20)),
                    lifespan(2),
                    "confetti"
                ]);
                
                confetti.onUpdate(() => {
                    confetti.move(rand(-50, 50), rand(-100, -50));
                    confetti.angle += rand(-360, 360) * dt();
                });
            }
        }

        // Show toasty moment
        function showToasty() {
            const toastyImg = add([
                rect(80, 80),
                pos(width() - 90, 10),
                color(255, 100, 100),
                lifespan(2),
                "toasty"
            ]);
            
            const toastyText = add([
                text("TOASTY!", { size: 20, font: "monospace" }),
                pos(width() - 150, 100),
                color(255, 255, 0),
                lifespan(2),
                "toasty"
            ]);
            
            // Animate entrance
            toastyImg.scale = 0;
            toastyText.scale = 0;
            
            tween(0, 1, 0.3, (val) => {
                toastyImg.scale = val;
                toastyText.scale = val;
            });
        }

        // Handle jump mechanics
        function handleJump(force = JUMP_FORCE) {
            const currentTime = time();
            
            if (quail.isGrounded()) {
                quail.jump(force);
                canDoubleJump = true;
                jumpCount++;
            } else if (canDoubleJump && currentTime - lastJumpTime > 0.1) {
                quail.jump(force * 0.8); // Slightly weaker double jump
                canDoubleJump = false;
                jumpCount++;
            }
            
            lastJumpTime = currentTime;
        }

        // Game scene
        scene("game", () => {
            // Create game objects
            const ground = createGround();
            const quail = get("quail")[0] || createQuail();
            
            // UI elements
            const scoreText = add([
                text("Score: 0", { size: 24, font: "monospace" }),
                pos(10, 10),
                color(255, 255, 255),
                "ui"
            ]);
            
            const speedText = add([
                text("Speed: " + Math.floor(gameSpeed), { size: 16, font: "monospace" }),
                pos(10, 40),
                color(255, 255, 255),
                "ui"
            ]);

            // Mega jump charge indicator
            const chargeBar = add([
                rect(0, 8),
                pos(QUAIL_START_X, GROUND_Y - 50),
                color(255, 255, 0),
                opacity(0),
                "chargeBar"
            ]);

            // Spawn cassettes
            const spawnCassette = () => {
                createCassette();
                wait(rand(1.5, 3), spawnCassette);
            };
            
            // Start spawning after a delay
            wait(2, spawnCassette);

            // Game loop
            onUpdate(() => {
                if (!gameStarted) return;
                
                // Create purple trail
                if (quail.isGrounded()) {
                    createTrail(quail.pos.x - 10, quail.pos.y + 10);
                }
                
                // Update score display
                scoreText.text = "Score: " + score;
                speedText.text = "Speed: " + Math.floor(gameSpeed);
                
                // Increase game speed over time
                gameSpeed += dt() * 10;
                
                // Update mega jump charge bar
                if (megaJumpCharging) {
                    megaJumpCharge = Math.min(megaJumpCharge + dt() * 2, 1);
                    chargeBar.width = megaJumpCharge * 100;
                    chargeBar.opacity = 0.8;
                } else {
                    chargeBar.opacity = 0;
                }
            });

            // Input handling
            onKeyPress("space", () => {
                if (!gameStarted) {
                    gameStarted = true;
                    return;
                }
                handleJump();
            });
            
            onKeyDown("space", () => {
                if (!megaJumpCharging && quail.isGrounded()) {
                    megaJumpCharging = true;
                    megaJumpCharge = 0;
                }
            });
            
            onKeyRelease("space", () => {
                if (megaJumpCharging) {
                    megaJumpCharging = false;
                    const jumpForce = JUMP_FORCE + (megaJumpCharge * (MEGA_JUMP_FORCE - JUMP_FORCE));
                    quail.jump(jumpForce);
                    megaJumpCharge = 0;
                }
            });

            // Touch/click handling for mobile
            onClick(() => {
                if (!gameStarted) {
                    gameStarted = true;
                    return;
                }
                handleJump();
            });

            // Collision detection
            quail.onCollide("cassette", (cassette) => {
                // Game over
                go("gameOver");
            });

            // Start message
            if (!gameStarted) {
                add([
                    text("TAP OR PRESS SPACE TO START\nQUAIL RUNNER", { 
                        size: 24, 
                        font: "monospace",
                        align: "center"
                    }),
                    pos(center().x, center().y - 50),
                    color(255, 255, 0),
                    anchor("center"),
                    "startText"
                ]);
            }
        });

        // Game over scene
        scene("gameOver", () => {
            add([
                text("GAME OVER", { size: 48, font: "monospace" }),
                pos(center().x, center().y - 100),
                color(255, 0, 0),
                anchor("center"),
            ]);
            
            add([
                text("Final Score: " + score, { size: 24, font: "monospace" }),
                pos(center().x, center().y - 50),
                color(255, 255, 255),
                anchor("center"),
            ]);
            
            add([
                text("Enemies Jumped: " + enemiesJumped, { size: 20, font: "monospace" }),
                pos(center().x, center().y - 20),
                color(255, 255, 255),
                anchor("center"),
            ]);
            
            add([
                text("TAP OR PRESS SPACE TO RESTART", { size: 16, font: "monospace" }),
                pos(center().x, center().y + 50),
                color(255, 255, 0),
                anchor("center"),
            ]);

            const restart = () => {
                // Reset game state
                score = 0;
                enemiesJumped = 0;
                gameSpeed = GAME_SPEED;
                jumpCount = 0;
                canDoubleJump = false;
                megaJumpCharging = false;
                megaJumpCharge = 0;
                gameStarted = false;
                
                go("game");
            };

            onKeyPress("space", restart);
            onClick(restart);
        });

        // Start the game
        go("game");
    </script>
</body>
</html>